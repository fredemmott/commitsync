#!/bin/sh
#!/bin/sh
# Copyright (c) 2020-present, Fred Emmott <fred@fredemmott.com>
# All rights reserved.
#
# This source code is licensed under the ISC license found in the LICENSE file
# in the root directory of this source tree.
#
# ---
#
# Store the current commit and metadata in the local commitcloud repository.
set -e

CC_BIN="$(dirname "$(realpath "$0")")"

function ccgit() {
  "$CC_BIN/cc-git" "$@"
}

# Add a file to the index without a checkout
# - Takes content on STDIN
# - Takes filename as $1
function ccstagefile() {
  ccgit update-index --add \
    --cacheinfo "100644,$(git hash-object -w --stdin),$1"
}

# Make sure we don't attempt to move a branch that another computer has
# already moved
#
# Ignore failures in case we're offline
ccgit fetch 2>/dev/null || true

# Where we're going to save this commit
REF="refs/heads/$($CC_BIN/cc-get-branch-name)"
# Where we're going to save metadata
META_REF="${REF/heads\/cc-/heads/ccmeta-}"

if "${CC_DEBUG:-false}"; then
  echo "ref\t$REF" >&2
  echo "meta\t$META_REF" >&2
fi

# Create the metadata first, in case something goes wrong
# Set the current branch, without a checkout
ccgit symbolic-ref HEAD ${META_REF}
REMOTE=$("$CC_BIN/cc-get-upstream")
hostname | ccstagefile hostname
whoami | ccstagefile user
date -R | ccstagefile datetime
echo $REMOTE | ccstagefile upstream.ref
git config remote.$(echo $REMOTE | cut -f3 -d/).url | ccstagefile upstream.url
git rev-parse HEAD | ccstagefile HEAD
META_PARENT=$(ccgit show-ref --hash ${META_REF} || true)
echo "FOO $META_PARENT"
if [ -z "$META_PARENT" ]; then
  if "${CC_DEBUG:-false}"; then
    echo "meta\tOrphan commit" >&2
  fi
  META_COMMIT=$(
    ccgit commit-tree \
      -m "Metadata for $REF" \
      $(ccgit write-tree)
  )
else
  if "${CC_DEBUG:-false}"; then
    echo "meta\tChild commit" >&2
  fi
  META_COMMIT=$(
    ccgit commit-tree \
      -m "Metadata for $REF" \
      -p "$META_PARENT" \
      $(ccgit write-tree)
  )
fi

# Update branches
ccgit update-ref $META_REF $META_COMMIT
ccgit update-ref $REF $(git rev-parse HEAD)
echo "Starting CommitCloud push..."
ccgit push commitcloud ${REF} ${META_REF} >/dev/null 2>/dev/null &
disown $!
